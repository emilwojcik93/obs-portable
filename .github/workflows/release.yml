name: OBS Studio IaC Release

on:
  push:
    branches: [main]
    paths:
      - "Deploy-OBSStudio.ps1"
      - "README.md"
  workflow_dispatch:
    # Allow manual triggering for testing

jobs:
  release:
    runs-on: windows-2025
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

       - name: Generate Version and Release Notes
         id: release_notes
         shell: pwsh
         run: |
           # Dynamic version calculation based on git tags and commits
           try {
             # Get latest tag
             $latestTag = git describe --tags --abbrev=0 2>$null
             if ($latestTag -match '^v?(\d+)\.(\d+)(?:\.(\d+))?') {
               $major = [int]$matches[1]
               $minor = [int]$matches[2] 
               $patch = if ($matches[3]) { [int]$matches[3] } else { 0 }
             } else {
               $major = 3; $minor = 0; $patch = 0
             }
             
             # Check if there are commits since last tag
             $commitsSinceTag = git rev-list --count HEAD ^$latestTag 2>$null
             if ($commitsSinceTag -gt 0) {
               $patch++  # Increment patch version for new commits
             }
             
             $version = "$major.$minor.$patch"
           } catch {
             # Fallback version if git operations fail
             $version = "3.1.0"
           }
           
           echo "VERSION=$version" >> $env:GITHUB_OUTPUT
           
           # Generate release notes from template
           $recentCommits = git log --pretty=format:"%s" -10 | Where-Object { $_ -match "^(🚀|✅|🔧|🛠️|📚|🎯|🔔|⚡|🐛)" }
           $commitList = $recentCommits -join "`n- "
           
           # Use release notes template
           $templateContent = Get-Content ".github/templates/release-notes.md" -Raw
           $releaseNotes = $templateContent -replace '\{\{VERSION\}\}', $version
           $releaseNotes = $releaseNotes -replace '\{\{RECENT_COMMITS\}\}', "- $commitList"
           
           echo "RELEASE_NOTES<<EOF" >> $env:GITHUB_OUTPUT
           echo $releaseNotes >> $env:GITHUB_OUTPUT
           echo "EOF" >> $env:GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.release_notes.outputs.VERSION }}
          name: "OBS Studio IaC v${{ steps.release_notes.outputs.VERSION }}"
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            Deploy-OBSStudio.ps1
            README.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "+ Released OBS Studio IaC v${{ steps.release_notes.outputs.VERSION }}"
          echo "Assets: Deploy-OBSStudio.ps1, README.md"
          echo "Remote execution ready!"
          echo ""
          echo "Usage:"
          echo '&([ScriptBlock]::Create((irm https://github.com/emilwojcik93/obs-portable/releases/latest/download/Deploy-OBSStudio.ps1))) -Force -SilentDeployment'
